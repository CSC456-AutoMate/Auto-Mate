---

- name: Create service file
  ansible.builtin.template:
    src: automate.j2
    dest: /etc/systemd/system/automate.service
    mode: 0644
  # notify: Reload systemctl
  # register: service_created

- name: Reload systemctl
  ansible.builtin.systemd_service:
    daemon_reload: true

- name: Stop service
  ansible.builtin.systemd:
    name: automate
    state: stopped
  # when: service_created is not changed

- name: Clone repo
  ansible.builtin.git:
    repo: https://github.com/armyf35/Auto-Mate.git
    dest: /opt/automate
    # single_branch: true
    version: assignment_deployment
    # force: true

- name: Create env
  ansible.builtin.template:
    src: env.j2
    dest: /opt/automate/.env
    mode: 0644

- name: Install packages based on package.json.
  community.general.npm:
    path: /opt/automate

- name: Build project
  ansible.builtin.shell: npm run build
  args:
    chdir: /opt/automate/

- name: Start service
  ansible.builtin.systemd:
    name: automate
    state: started
